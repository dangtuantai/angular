import{E as P,J as m,M as p,P as f,S as d,a as T,b as y,h as I,i as C,ib as w,l,lb as k,m as b,o as u,y as g}from"./chunk-UI65ZESQ.js";var U={local:{authUrl:"localhost:5000",apiUrl:"localhost:5000"}};var x=window._ENV,n=U[x];var _=class{constructor(){}static isTokenExpired(t,s){if(!t||t==="")return!0;let e=this._getTokenExpirationDate(t);return s=s||0,e===null?!0:!(e.valueOf()>new Date().valueOf()+s*1e3)}static _b64decode(t){let s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",e="";if(t=String(t).replace(/=+$/,""),t.length%4===1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(let r=0,a,i,o=0;i=t.charAt(o++);~i&&(a=r%4?a*64+i:i,r++%4)?e+=String.fromCharCode(255&a>>(-2*r&6)):0)i=s.indexOf(i);return e}static _b64DecodeUnicode(t){return decodeURIComponent(Array.prototype.map.call(this._b64decode(t),s=>"%"+("00"+s.charCodeAt(0).toString(16)).slice(-2)).join(""))}static _urlBase64Decode(t){let s=t.replace(/-/g,"+").replace(/_/g,"/");switch(s.length%4){case 0:break;case 2:{s+="==";break}case 3:{s+="=";break}default:throw Error("Illegal base64url string!")}return this._b64DecodeUnicode(s)}static _decodeToken(t){if(!t)return null;let s=t.split(".");if(s.length!==3)throw new Error("The inspected token doesn't appear to be a JWT. Check to make sure it has three parts and see https://jwt.io for more.");let e=this._urlBase64Decode(s[1]);if(!e)throw new Error("Cannot decode the token.");return JSON.parse(e)}static _getTokenExpirationDate(t){let s=this._decodeToken(t);if(!s.hasOwnProperty("exp"))return null;let e=new Date(0);return e.setUTCSeconds(s.exp),e}};var S=(()=>{let t=class t{constructor(e){this._httpClient=e,this._user=new I(1)}set user(e){this._user.next(e),this._userData=e}get user(){return this._userData}get user$(){return this._user.asObservable()}get(){return this._httpClient.get(`${n.authUrl}/auth/realms/${n.realm}/account`).pipe(u(e=>y(T({},e),{attributes:e.attributes||{}})),p(e=>{this._user.next(e)}))}update(e){return this._httpClient.patch("api/common/user",{user:e}).pipe(u(r=>{this._user.next(r)}))}};t.\u0275fac=function(r){return new(r||t)(d(k))},t.\u0275prov=f({token:t,factory:t.\u0275fac,providedIn:"root"});let h=t;return h})();var X=(()=>{let t=class t{constructor(e,r){this._httpClient=e,this._userService=r,this._authenticated=!1,this._permissions=[],this._tokenPayload={}}get authenticated(){return this._authenticated}get permissions(){return this._permissions}get tokenPayload(){return this._tokenPayload}set tokenPayload(e){this._tokenPayload=e}get accessToken(){return localStorage.getItem("accessToken")??""}set accessToken(e){localStorage.setItem("accessToken",e)}get refreshToken(){return localStorage.getItem("refreshToken")??""}set refreshToken(e){localStorage.setItem("refreshToken",e)}forgotPassword(e){return this._httpClient.post("api/auth/forgot-password",e)}resetPassword(e){return this._httpClient.post("api/auth/reset-password",e)}signIn(e){if(this._authenticated)return b("User is already logged in.");let r={headers:new w().set("Content-Type","application/x-www-form-urlencoded")},a=new URLSearchParams,i={username:e.username,password:e.password,client_id:n.clientId,grant_type:"password"};for(let c in i)i.hasOwnProperty(c)&&a.set(c,i[c]);return l({access_token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoidGFpIn0.kHCzK3XorPrfi0DcYAlZar2terCRblCSHUv7TfDYaa4"}).pipe(m(c=>(this.accessToken=c.access_token,this.refreshToken=c.refresh_token,this.tokenPayload=this.parseJwt(c.access_token),console.log(this.tokenPayload),this._permissions=this.tokenPayload.resource_access?.frontend?.roles||[],this._authenticated=!0,this.getUserProfile())))}signInUsingToken(){let e=new URLSearchParams,r={client_id:n.clientId,grant_type:"refresh_token",refresh_token:this.refreshToken};for(let o in r)r.hasOwnProperty(o)&&e.set(o,r[o]);let a={headers:new w().set("Content-Type","application/x-www-form-urlencoded")};return l({access_token:"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VyIjoidGFpIn0.kHCzK3XorPrfi0DcYAlZar2terCRblCSHUv7TfDYaa4"}).pipe(g(()=>l(!1)),u(o=>{if(typeof o=="boolean")throw new Error("D\u1EEF li\u1EC7u kh\xF4ng h\u1EE3p l\u1EC7");return{}}),m(o=>(o.access_token&&(this.accessToken=o.access_token,this.tokenPayload=this.parseJwt(o.access_token),this._permissions=this.tokenPayload.resource_access?.frontend?.roles||[]),o.refresh_token&&(this.refreshToken=o.refresh_token),this._authenticated=!0,this.getUserProfile())))}signOut(){return this._authenticated=!1,this._httpClient.post(`${n.authUrl}/auth/admin/realms/${n.realm}/users/${this._userService.user?.id}/logout`,{}).pipe(g(e=>(console.error(e),C)),P(()=>{localStorage.removeItem("accessToken"),localStorage.removeItem("refreshToken")}))}signUp(e){return this._httpClient.post("api/auth/sign-up",e)}unlockSession(e){return this._httpClient.post("api/auth/unlock-session",e)}check(){return this._authenticated?l(!0):(console.log(this.accessToken),this.accessToken?(console.log(this.accessToken),console.log(_.isTokenExpired(this.accessToken)),console.log(12321321),this.signInUsingToken()):l(!1))}checkPermission(e){return e&&!this._permissions.some(r=>e.some(a=>a===r))}getUserProfile(){return l({id:1,username:"t\xE0i",email:"t\xE0i",emailVerified:"t\xE0i"}).pipe(u(e=>({id:e.id,username:e.username,email:e.email,emailVerified:e.emailVerified})),p(e=>{this._userService.user=e}))}parseJwt(e){let a=e.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),i=decodeURIComponent(window.atob(a).split("").map(function(o){return"%"+("00"+o.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(i)}};t.\u0275fac=function(r){return new(r||t)(d(k),d(S))},t.\u0275prov=f({token:t,factory:t.\u0275fac});let h=t;return h})();export{n as a,_ as b,S as c,X as d};
