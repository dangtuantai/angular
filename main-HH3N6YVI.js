import{h as tt,u as st}from"./chunk-PIB62LY2.js";import{a as it,b as nt,c as at,d as L}from"./chunk-4H7L6RDO.js";import{$ as Je,A as Be,C as q,F as K,J as R,M as we,P as _,Q as j,R as Ye,S as x,U as ze,V as D,Ya as qe,_ as Ve,c as E,f as ve,fb as Ke,ib as U,jb as N,k as Pe,kb as Ge,l as w,lb as Ze,m as M,mb as I,n as He,na as $e,nb as G,o as Q,p as Fe,pb as Xe,q as Me,qb as et,u as Re,ub as rt,v as T,vb as W,w as Ne,xb as ot,y as O,ya as Qe,yb as ye,z as We}from"./chunk-UI65ZESQ.js";var ct=(()=>{let t=class t{constructor(){}ngOnInit(){return E(this,null,function*(){})}};t.\u0275fac=function(s){return new(s||t)},t.\u0275cmp=ze({type:t,selectors:[["app-root"]],decls:1,vars:0,template:function(s,r){s&1&&Qe(0,"router-outlet")},dependencies:[rt],encapsulation:2,changeDetection:0});let o=t;return o})();var _e=(()=>{let t=class t{constructor(e,s){this._authService=e,this._router=s}canActivate(e,s){return this._check()}canActivateChild(e,s){return this._check()}canLoad(e,s){return this._check()}_check(){return this._authService.check().pipe(R(e=>e?(this._router.navigate([""]),w(!1)):w(!0)))}};t.\u0275fac=function(s){return new(s||t)(x(L),x(W))},t.\u0275prov=_({token:t,factory:t.\u0275fac,providedIn:"root"});let o=t;return o})();var Z=(()=>{let t=class t{constructor(e,s,r){this._authService=e,this._userService=s,this._router=r}canActivate(e,s){let r=s.url==="/sign-out"?"/":s.url;return this._check(r,e.data?.permission)}canActivateChild(e,s){let r=s.url==="/sign-out"?"/":s.url;return this._check(r,e.data?.permission)}canLoad(e,s){return this._check("/",e.data?.permission)}_check(e,s){return this._authService.check().pipe(R(r=>r?w(!0):(this._router.navigate(["sign-in"],{queryParams:{redirectURL:e}}),w(!1))))}};t.\u0275fac=function(s){return new(s||t)(x(L),x(at),x(W))},t.\u0275prov=_({token:t,factory:t.\u0275fac,providedIn:"root"});let o=t;return o})();var Ct=[{path:"main",canActivate:[Z],loadChildren:()=>import("./chunk-4R7U5FB5.js").then(o=>o.MainPageRoutingModule)},{path:"sign-in",canActivate:[_e],canActivateChild:[_e],loadChildren:()=>import("./chunk-6CLBHM5E.js").then(o=>o.AuthSignInModule)},{path:"sign-out",canActivate:[Z],canActivateChild:[Z],loadChildren:()=>import("./chunk-3Z6X3CTT.js").then(o=>o.AuthSignOutModule)},{path:"**",redirectTo:"main",pathMatch:"full"}],ft=(()=>{let t=class t{};t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=D({type:t}),t.\u0275inj=j({imports:[ye.forRoot(Ct,{preloadingStrategy:ot,onSameUrlNavigation:"reload"}),ye]});let o=t;return o})();var X=class{validateSignature(t){return Promise.resolve(null)}validateAtHash(t){return Promise.resolve(!0)}},ee=class{};var Y=class{},At=(()=>{let t=class t extends Y{now(){return Date.now()}new(){return new Date}};t.\u0275fac=(()=>{let e;return function(r){return(e||(e=Ve(t)))(r||t)}})(),t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})();var te=class{},se=class{},Et=(()=>{let t=class t{constructor(){this.data=new Map}getItem(e){return this.data.get(e)}removeItem(e){this.data.delete(e)}setItem(e,s){this.data.set(e,s)}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})();var z=class{constructor(t){this.type=t}},b=class extends z{constructor(t,c=null){super(t),this.info=c}},C=class extends z{constructor(t,c=null){super(t),this.info=c}},k=class extends z{constructor(t,c,e=null){super(t),this.reason=c,this.params=e}};function ut(o){let t=o.replace(/-/g,"+").replace(/_/g,"/");return decodeURIComponent(atob(t).split("").map(function(c){return"%"+("00"+c.charCodeAt(0).toString(16)).slice(-2)}).join(""))}function ht(o){return btoa(o).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}var B=class{constructor(t){this.clientId="",this.redirectUri="",this.postLogoutRedirectUri="",this.redirectUriAsPostLogoutRedirectUriFallback=!0,this.loginUrl="",this.scope="openid profile",this.resource="",this.rngUrl="",this.oidc=!0,this.requestAccessToken=!0,this.options=null,this.issuer="",this.logoutUrl="",this.clearHashAfterLogin=!0,this.tokenEndpoint=null,this.revocationEndpoint=null,this.customTokenParameters=[],this.userinfoEndpoint=null,this.responseType="",this.showDebugInformation=!1,this.silentRefreshRedirectUri="",this.silentRefreshMessagePrefix="",this.silentRefreshShowIFrame=!1,this.siletRefreshTimeout=1e3*20,this.silentRefreshTimeout=1e3*20,this.dummyClientSecret="",this.requireHttps="remoteOnly",this.strictDiscoveryDocumentValidation=!0,this.jwks=null,this.customQueryParams=null,this.silentRefreshIFrameName="angular-oauth-oidc-silent-refresh-iframe",this.timeoutFactor=.75,this.sessionChecksEnabled=!1,this.sessionCheckIntervall=3*1e3,this.sessionCheckIFrameUrl=null,this.sessionCheckIFrameName="angular-oauth-oidc-check-session-iframe",this.disableAtHashCheck=!1,this.skipSubjectCheck=!1,this.useIdTokenHintForSilentRefresh=!1,this.skipIssuerCheck=!1,this.nonceStateSeparator=";",this.useHttpBasicAuth=!1,this.decreaseExpirationBySec=0,this.waitForTokenInMsec=0,this.disablePKCE=!1,this.preserveRequestedRoute=!1,this.disableIdTokenTimer=!1,this.checkOrigin=!1,this.openUri=c=>{location.href=c},t&&Object.assign(this,t)}},F=class{encodeKey(t){return encodeURIComponent(t)}encodeValue(t){return encodeURIComponent(t)}decodeKey(t){return decodeURIComponent(t)}decodeValue(t){return decodeURIComponent(t)}},re=class{};var dt=(()=>{let t=class t{getHashFragmentParams(e){let s=e||window.location.hash;if(s=decodeURIComponent(s),s.indexOf("#")!==0)return{};let r=s.indexOf("?");return r>-1?s=s.substr(r+1):s=s.substr(1),this.parseQueryString(s)}parseQueryString(e){let s={},r,i,n,a,f,d;if(e===null)return s;let p=e.split("&");for(let l=0;l<p.length;l++)r=p[l],i=r.indexOf("="),i===-1?(n=r,a=null):(n=r.substr(0,i),a=r.substr(i+1)),f=decodeURIComponent(n),d=decodeURIComponent(a),f.substr(0,1)==="/"&&(f=f.substr(1)),s[f]=d;return s}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})(),mt=32,Ot=64,jt=new Uint32Array([1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298]);function be(o,t,c,e,s){let r,i,n,a,f,d,p,l,h,u,v,S,H;for(;s>=64;){for(r=t[0],i=t[1],n=t[2],a=t[3],f=t[4],d=t[5],p=t[6],l=t[7],u=0;u<16;u++)v=e+u*4,o[u]=(c[v]&255)<<24|(c[v+1]&255)<<16|(c[v+2]&255)<<8|c[v+3]&255;for(u=16;u<64;u++)h=o[u-2],S=(h>>>17|h<<32-17)^(h>>>19|h<<32-19)^h>>>10,h=o[u-15],H=(h>>>7|h<<32-7)^(h>>>18|h<<32-18)^h>>>3,o[u]=(S+o[u-7]|0)+(H+o[u-16]|0);for(u=0;u<64;u++)S=(((f>>>6|f<<32-6)^(f>>>11|f<<32-11)^(f>>>25|f<<32-25))+(f&d^~f&p)|0)+(l+(jt[u]+o[u]|0)|0)|0,H=((r>>>2|r<<32-2)^(r>>>13|r<<32-13)^(r>>>22|r<<32-22))+(r&i^r&n^i&n)|0,l=p,p=d,d=f,f=a+S|0,a=n,n=i,i=r,r=S+H|0;t[0]+=r,t[1]+=i,t[2]+=n,t[3]+=a,t[4]+=f,t[5]+=d,t[6]+=p,t[7]+=l,e+=64,s-=64}return e}var Te=class{constructor(){this.digestLength=mt,this.blockSize=Ot,this.state=new Int32Array(8),this.temp=new Int32Array(64),this.buffer=new Uint8Array(128),this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this.reset()}reset(){return this.state[0]=1779033703,this.state[1]=3144134277,this.state[2]=1013904242,this.state[3]=2773480762,this.state[4]=1359893119,this.state[5]=2600822924,this.state[6]=528734635,this.state[7]=1541459225,this.bufferLength=0,this.bytesHashed=0,this.finished=!1,this}clean(){for(let t=0;t<this.buffer.length;t++)this.buffer[t]=0;for(let t=0;t<this.temp.length;t++)this.temp[t]=0;this.reset()}update(t,c=t.length){if(this.finished)throw new Error("SHA256: can't update because hash was finished.");let e=0;if(this.bytesHashed+=c,this.bufferLength>0){for(;this.bufferLength<64&&c>0;)this.buffer[this.bufferLength++]=t[e++],c--;this.bufferLength===64&&(be(this.temp,this.state,this.buffer,0,64),this.bufferLength=0)}for(c>=64&&(e=be(this.temp,this.state,t,e,c),c%=64);c>0;)this.buffer[this.bufferLength++]=t[e++],c--;return this}finish(t){if(!this.finished){let c=this.bytesHashed,e=this.bufferLength,s=c/536870912|0,r=c<<3,i=c%64<56?64:128;this.buffer[e]=128;for(let n=e+1;n<i-8;n++)this.buffer[n]=0;this.buffer[i-8]=s>>>24&255,this.buffer[i-7]=s>>>16&255,this.buffer[i-6]=s>>>8&255,this.buffer[i-5]=s>>>0&255,this.buffer[i-4]=r>>>24&255,this.buffer[i-3]=r>>>16&255,this.buffer[i-2]=r>>>8&255,this.buffer[i-1]=r>>>0&255,be(this.temp,this.state,this.buffer,0,i),this.finished=!0}for(let c=0;c<8;c++)t[c*4+0]=this.state[c]>>>24&255,t[c*4+1]=this.state[c]>>>16&255,t[c*4+2]=this.state[c]>>>8&255,t[c*4+3]=this.state[c]>>>0&255;return this}digest(){let t=new Uint8Array(this.digestLength);return this.finish(t),t}_saveState(t){for(let c=0;c<this.state.length;c++)t[c]=this.state[c]}_restoreState(t,c){for(let e=0;e<this.state.length;e++)this.state[e]=t[e];this.bytesHashed=c,this.finished=!1,this.bufferLength=0}};function Dt(o){let t=new Te().update(o),c=t.digest();return t.clean(),c}var cs=new Uint8Array(mt);var oe=class{};function Ut(o){if(typeof o!="string")throw new TypeError("expected string");let t=o,c=new Uint8Array(t.length);for(let e=0;e<t.length;e++)c[e]=t.charCodeAt(e);return c}function Lt(o){let t=[];for(let c=0;c<o.length;c++)t.push(String.fromCharCode(o[c]));return t.join("")}var Pt=(()=>{let t=class t{calcHash(e,s){return E(this,null,function*(){return Lt(Dt(Ut(e)))})}toHashString2(e){let s="";for(let r of e)s+=String.fromCharCode(r);return s}toHashString(e){let s=new Uint8Array(e),r="";for(let i of s)r+=String.fromCharCode(i);return r}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})(),pt=(()=>{let t=class t extends B{constructor(e,s,r,i,n,a,f,d,p,l){super(),this.ngZone=e,this.http=s,this.config=n,this.urlHelper=a,this.logger=f,this.crypto=d,this.dateTimeService=l,this.discoveryDocumentLoaded=!1,this.state="",this.eventsSubject=new ve,this.discoveryDocumentLoadedSubject=new ve,this.grantTypesSupported=[],this.inImplicitFlow=!1,this.saveNoncesInLocalStorage=!1,this.debug("angular-oauth2-oidc v10"),this.document=p,n||(n={}),this.discoveryDocumentLoaded$=this.discoveryDocumentLoadedSubject.asObservable(),this.events=this.eventsSubject.asObservable(),i&&(this.tokenValidationHandler=i),n&&this.configure(n);try{r?this.setStorage(r):typeof sessionStorage<"u"&&this.setStorage(sessionStorage)}catch(h){console.error("No OAuthStorage provided and cannot access default (sessionStorage).Consider providing a custom OAuthStorage implementation in your module.",h)}if(this.checkLocalStorageAccessable()){let h=window?.navigator?.userAgent;(h?.includes("MSIE ")||h?.includes("Trident"))&&(this.saveNoncesInLocalStorage=!0)}this.setupRefreshTimer()}checkLocalStorageAccessable(){if(typeof window>"u")return!1;let e="test";try{return typeof window.localStorage>"u"?!1:(localStorage.setItem(e,e),localStorage.removeItem(e),!0)}catch{return!1}}configure(e){Object.assign(this,new B,e),this.config=Object.assign({},new B,e),this.sessionChecksEnabled&&this.setupSessionCheck(),this.configChanged()}configChanged(){this.setupRefreshTimer()}restartSessionChecksIfStillLoggedIn(){this.hasValidIdToken()&&this.initSessionCheck()}restartRefreshTimerIfStillLoggedIn(){this.setupExpirationTimers()}setupSessionCheck(){this.events.pipe(T(e=>e.type==="token_received")).subscribe(()=>{this.initSessionCheck()})}setupAutomaticSilentRefresh(e={},s,r=!0){let i=!0;this.clearAutomaticRefreshTimer(),this.automaticRefreshSubscription=this.events.pipe(we(n=>{n.type==="token_received"?i=!0:n.type==="logout"&&(i=!1)}),T(n=>n.type==="token_expires"&&(s==null||s==="any"||n.info===s)),We(1e3)).subscribe(()=>{i&&this.refreshInternal(e,r).catch(()=>{this.debug("Automatic silent refresh did not work")})}),this.restartRefreshTimerIfStillLoggedIn()}refreshInternal(e,s){return!this.useSilentRefresh&&this.responseType==="code"?this.refreshToken():this.silentRefresh(e,s)}loadDiscoveryDocumentAndTryLogin(e=null){return this.loadDiscoveryDocument().then(()=>this.tryLogin(e))}loadDiscoveryDocumentAndLogin(e=null){return e=e||{},this.loadDiscoveryDocumentAndTryLogin(e).then(()=>{if(!this.hasValidIdToken()||!this.hasValidAccessToken()){let s=typeof e.state=="string"?e.state:"";return this.initLoginFlow(s),!1}else return!0})}debug(...e){this.showDebugInformation&&this.logger.debug(...e)}validateUrlFromDiscoveryDocument(e){let s=[],r=this.validateUrlForHttps(e),i=this.validateUrlAgainstIssuer(e);return r||s.push("https for all urls required. Also for urls received by discovery."),i||s.push("Every url in discovery document has to start with the issuer url.Also see property strictDiscoveryDocumentValidation."),s}validateUrlForHttps(e){if(!e)return!0;let s=e.toLowerCase();return this.requireHttps===!1||(s.match(/^http:\/\/localhost($|[:/])/)||s.match(/^http:\/\/localhost($|[:/])/))&&this.requireHttps==="remoteOnly"?!0:s.startsWith("https://")}assertUrlNotNullAndCorrectProtocol(e,s){if(!e)throw new Error(`'${s}' should not be null`);if(!this.validateUrlForHttps(e))throw new Error(`'${s}' must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).`)}validateUrlAgainstIssuer(e){return!this.strictDiscoveryDocumentValidation||!e?!0:e.toLowerCase().startsWith(this.issuer.toLowerCase())}setupRefreshTimer(){if(typeof window>"u"){this.debug("timer not supported on this plattform");return}(this.hasValidIdToken()||this.hasValidAccessToken())&&(this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()),this.tokenReceivedSubscription&&this.tokenReceivedSubscription.unsubscribe(),this.tokenReceivedSubscription=this.events.pipe(T(e=>e.type==="token_received")).subscribe(()=>{this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.setupExpirationTimers()})}setupExpirationTimers(){this.hasValidAccessToken()&&this.setupAccessTokenTimer(),!this.disableIdTokenTimer&&this.hasValidIdToken()&&this.setupIdTokenTimer()}setupAccessTokenTimer(){let e=this.getAccessTokenExpiration(),s=this.getAccessTokenStoredAt(),r=this.calcTimeout(s,e);this.ngZone.runOutsideAngular(()=>{this.accessTokenTimeoutSubscription=w(new C("token_expires","access_token")).pipe(q(r)).subscribe(i=>{this.ngZone.run(()=>{this.eventsSubject.next(i)})})})}setupIdTokenTimer(){let e=this.getIdTokenExpiration(),s=this.getIdTokenStoredAt(),r=this.calcTimeout(s,e);this.ngZone.runOutsideAngular(()=>{this.idTokenTimeoutSubscription=w(new C("token_expires","id_token")).pipe(q(r)).subscribe(i=>{this.ngZone.run(()=>{this.eventsSubject.next(i)})})})}stopAutomaticRefresh(){this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.clearAutomaticRefreshTimer()}clearAccessTokenTimer(){this.accessTokenTimeoutSubscription&&this.accessTokenTimeoutSubscription.unsubscribe()}clearIdTokenTimer(){this.idTokenTimeoutSubscription&&this.idTokenTimeoutSubscription.unsubscribe()}clearAutomaticRefreshTimer(){this.automaticRefreshSubscription&&this.automaticRefreshSubscription.unsubscribe()}calcTimeout(e,s){let r=this.dateTimeService.now(),i=(s-e)*this.timeoutFactor-(r-e),n=Math.max(0,i),a=2147483647;return n>a?a:n}setStorage(e){this._storage=e,this.configChanged()}loadDiscoveryDocument(e=null){return new Promise((s,r)=>{if(e||(e=this.issuer||"",e.endsWith("/")||(e+="/"),e+=".well-known/openid-configuration"),!this.validateUrlForHttps(e)){r("issuer  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");return}this.http.get(e).subscribe(i=>{if(!this.validateDiscoveryDocument(i)){this.eventsSubject.next(new k("discovery_document_validation_error",null)),r("discovery_document_validation_error");return}this.loginUrl=i.authorization_endpoint,this.logoutUrl=i.end_session_endpoint||this.logoutUrl,this.grantTypesSupported=i.grant_types_supported,this.issuer=i.issuer,this.tokenEndpoint=i.token_endpoint,this.userinfoEndpoint=i.userinfo_endpoint||this.userinfoEndpoint,this.jwksUri=i.jwks_uri,this.sessionCheckIFrameUrl=i.check_session_iframe||this.sessionCheckIFrameUrl,this.discoveryDocumentLoaded=!0,this.discoveryDocumentLoadedSubject.next(i),this.revocationEndpoint=i.revocation_endpoint||this.revocationEndpoint,this.sessionChecksEnabled&&this.restartSessionChecksIfStillLoggedIn(),this.loadJwks().then(n=>{let a={discoveryDocument:i,jwks:n},f=new b("discovery_document_loaded",a);this.eventsSubject.next(f),s(f)}).catch(n=>{this.eventsSubject.next(new k("discovery_document_load_error",n)),r(n)})},i=>{this.logger.error("error loading discovery document",i),this.eventsSubject.next(new k("discovery_document_load_error",i)),r(i)})})}loadJwks(){return new Promise((e,s)=>{this.jwksUri?this.http.get(this.jwksUri).subscribe(r=>{this.jwks=r,e(r)},r=>{this.logger.error("error loading jwks",r),this.eventsSubject.next(new k("jwks_load_error",r)),s(r)}):e(null)})}validateDiscoveryDocument(e){let s;return!this.skipIssuerCheck&&e.issuer!==this.issuer?(this.logger.error("invalid issuer in discovery document","expected: "+this.issuer,"current: "+e.issuer),!1):(s=this.validateUrlFromDiscoveryDocument(e.authorization_endpoint),s.length>0?(this.logger.error("error validating authorization_endpoint in discovery document",s),!1):(s=this.validateUrlFromDiscoveryDocument(e.end_session_endpoint),s.length>0?(this.logger.error("error validating end_session_endpoint in discovery document",s),!1):(s=this.validateUrlFromDiscoveryDocument(e.token_endpoint),s.length>0&&this.logger.error("error validating token_endpoint in discovery document",s),s=this.validateUrlFromDiscoveryDocument(e.revocation_endpoint),s.length>0&&this.logger.error("error validating revocation_endpoint in discovery document",s),s=this.validateUrlFromDiscoveryDocument(e.userinfo_endpoint),s.length>0?(this.logger.error("error validating userinfo_endpoint in discovery document",s),!1):(s=this.validateUrlFromDiscoveryDocument(e.jwks_uri),s.length>0?(this.logger.error("error validating jwks_uri in discovery document",s),!1):(this.sessionChecksEnabled&&!e.check_session_iframe&&this.logger.warn("sessionChecksEnabled is activated but discovery document does not contain a check_session_iframe field"),!0)))))}fetchTokenUsingPasswordFlowAndLoadUserProfile(e,s,r=new U){return this.fetchTokenUsingPasswordFlow(e,s,r).then(()=>this.loadUserProfile())}loadUserProfile(){if(!this.hasValidAccessToken())throw new Error("Can not load User Profile without access_token");if(!this.validateUrlForHttps(this.userinfoEndpoint))throw new Error("userinfoEndpoint must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");return new Promise((e,s)=>{let r=new U().set("Authorization","Bearer "+this.getAccessToken());this.http.get(this.userinfoEndpoint,{headers:r,observe:"response",responseType:"text"}).subscribe(i=>{if(this.debug("userinfo received",JSON.stringify(i)),i.headers.get("content-type").startsWith("application/json")){let n=JSON.parse(i.body),a=this.getIdentityClaims()||{};if(!this.skipSubjectCheck&&this.oidc&&(!a.sub||n.sub!==a.sub)){s(`if property oidc is true, the received user-id (sub) has to be the user-id of the user that has logged in with oidc.
if you are not using oidc but just oauth2 password flow set oidc to false`);return}n=Object.assign({},a,n),this._storage.setItem("id_token_claims_obj",JSON.stringify(n)),this.eventsSubject.next(new b("user_profile_loaded")),e({info:n})}else this.debug("userinfo is not JSON, treating it as JWE/JWS"),this.eventsSubject.next(new b("user_profile_loaded")),e(JSON.parse(i.body))},i=>{this.logger.error("error loading user info",i),this.eventsSubject.next(new k("user_profile_load_error",i)),s(i)})})}fetchTokenUsingPasswordFlow(e,s,r=new U){let i={username:e,password:s};return this.fetchTokenUsingGrant("password",i,r)}fetchTokenUsingGrant(e,s,r=new U){this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint");let i=new N({encoder:new F}).set("grant_type",e).set("scope",this.scope);if(this.useHttpBasicAuth){let n=btoa(`${this.clientId}:${this.dummyClientSecret}`);r=r.set("Authorization","Basic "+n)}if(this.useHttpBasicAuth||(i=i.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(i=i.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let n of Object.getOwnPropertyNames(this.customQueryParams))i=i.set(n,this.customQueryParams[n]);for(let n of Object.keys(s))i=i.set(n,s[n]);return r=r.set("Content-Type","application/x-www-form-urlencoded"),new Promise((n,a)=>{this.http.post(this.tokenEndpoint,i,{headers:r}).subscribe(f=>{this.debug("tokenResponse",f),this.storeAccessTokenResponse(f.access_token,f.refresh_token,f.expires_in||this.fallbackAccessTokenExpirationTimeInSec,f.scope,this.extractRecognizedCustomParameters(f)),this.oidc&&f.id_token&&this.processIdToken(f.id_token,f.access_token).then(d=>{this.storeIdToken(d),n(f)}),this.eventsSubject.next(new b("token_received")),n(f)},f=>{this.logger.error("Error performing ${grantType} flow",f),this.eventsSubject.next(new k("token_error",f)),a(f)})})}refreshToken(){return this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint"),new Promise((e,s)=>{let r=new N({encoder:new F}).set("grant_type","refresh_token").set("scope",this.scope).set("refresh_token",this._storage.getItem("refresh_token")),i=new U().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let n=btoa(`${this.clientId}:${this.dummyClientSecret}`);i=i.set("Authorization","Basic "+n)}if(this.useHttpBasicAuth||(r=r.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(r=r.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let n of Object.getOwnPropertyNames(this.customQueryParams))r=r.set(n,this.customQueryParams[n]);this.http.post(this.tokenEndpoint,r,{headers:i}).pipe(R(n=>this.oidc&&n.id_token?Pe(this.processIdToken(n.id_token,n.access_token,!0)).pipe(we(a=>this.storeIdToken(a)),Q(()=>n)):w(n))).subscribe(n=>{this.debug("refresh tokenResponse",n),this.storeAccessTokenResponse(n.access_token,n.refresh_token,n.expires_in||this.fallbackAccessTokenExpirationTimeInSec,n.scope,this.extractRecognizedCustomParameters(n)),this.eventsSubject.next(new b("token_received")),this.eventsSubject.next(new b("token_refreshed")),e(n)},n=>{this.logger.error("Error refreshing token",n),this.eventsSubject.next(new k("token_refresh_error",n)),s(n)})})}removeSilentRefreshEventListener(){this.silentRefreshPostMessageEventListener&&(window.removeEventListener("message",this.silentRefreshPostMessageEventListener),this.silentRefreshPostMessageEventListener=null)}setupSilentRefreshEventListener(){this.removeSilentRefreshEventListener(),this.silentRefreshPostMessageEventListener=e=>{let s=this.processMessageEventMessage(e);this.checkOrigin&&e.origin!==location.origin&&console.error("wrong origin requested silent refresh!"),this.tryLogin({customHashFragment:s,preventClearHashAfterLogin:!0,customRedirectUri:this.silentRefreshRedirectUri||this.redirectUri}).catch(r=>this.debug("tryLogin during silent refresh failed",r))},window.addEventListener("message",this.silentRefreshPostMessageEventListener)}silentRefresh(e={},s=!0){let r=this.getIdentityClaims()||{};if(this.useIdTokenHintForSilentRefresh&&this.hasValidIdToken()&&(e.id_token_hint=this.getIdToken()),!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if(typeof this.document>"u")throw new Error("silent refresh is not supported on this platform");let i=this.document.getElementById(this.silentRefreshIFrameName);i&&this.document.body.removeChild(i),this.silentRefreshSubject=r.sub;let n=this.document.createElement("iframe");n.id=this.silentRefreshIFrameName,this.setupSilentRefreshEventListener();let a=this.silentRefreshRedirectUri||this.redirectUri;this.createLoginUrl(null,null,a,s,e).then(l=>{n.setAttribute("src",l),this.silentRefreshShowIFrame||(n.style.display="none"),this.document.body.appendChild(n)});let f=this.events.pipe(T(l=>l instanceof k),K()),d=this.events.pipe(T(l=>l.type==="token_received"),K()),p=w(new k("silent_refresh_timeout",null)).pipe(q(this.silentRefreshTimeout));return Ne([f,d,p]).pipe(Q(l=>{if(l instanceof k)throw l.type==="silent_refresh_timeout"?this.eventsSubject.next(l):(l=new k("silent_refresh_error",l),this.eventsSubject.next(l)),l;return l.type==="token_received"&&(l=new b("silently_refreshed"),this.eventsSubject.next(l)),l})).toPromise()}initImplicitFlowInPopup(e){return this.initLoginFlowInPopup(e)}initLoginFlowInPopup(e){return e=e||{},this.createLoginUrl(null,null,this.silentRefreshRedirectUri,!1,{display:"popup"}).then(s=>new Promise((r,i)=>{let a=null;e.windowRef?e.windowRef&&!e.windowRef.closed&&(a=e.windowRef,a.location.href=s):a=window.open(s,"ngx-oauth2-oidc-login",this.calculatePopupFeatures(e));let f,d=v=>{this.tryLogin({customHashFragment:v,preventClearHashAfterLogin:!0,customRedirectUri:this.silentRefreshRedirectUri}).then(()=>{l(),r(!0)},S=>{l(),i(S)})},p=()=>{(!a||a.closed)&&(l(),i(new k("popup_closed",{})))};a?f=window.setInterval(p,500):i(new k("popup_blocked",{}));let l=()=>{window.clearInterval(f),window.removeEventListener("storage",u),window.removeEventListener("message",h),a!==null&&a.close(),a=null},h=v=>{let S=this.processMessageEventMessage(v);S&&S!==null?(window.removeEventListener("storage",u),d(S)):console.log("false event firing")},u=v=>{v.key==="auth_hash"&&(window.removeEventListener("message",h),d(v.newValue))};window.addEventListener("message",h),window.addEventListener("storage",u)}))}calculatePopupFeatures(e){let s=e.height||470,r=e.width||500,i=window.screenLeft+(window.outerWidth-r)/2,n=window.screenTop+(window.outerHeight-s)/2;return`location=no,toolbar=no,width=${r},height=${s},top=${n},left=${i}`}processMessageEventMessage(e){let s="#";if(this.silentRefreshMessagePrefix&&(s+=this.silentRefreshMessagePrefix),!e||!e.data||typeof e.data!="string")return;let r=e.data;if(r.startsWith(s))return"#"+r.substr(s.length)}canPerformSessionCheck(){return this.sessionChecksEnabled?this.sessionCheckIFrameUrl?this.getSessionState()?!(typeof this.document>"u"):(console.warn("sessionChecksEnabled is activated but there is no session_state"),!1):(console.warn("sessionChecksEnabled is activated but there is no sessionCheckIFrameUrl"),!1):!1}setupSessionCheckEventListener(){this.removeSessionCheckEventListener(),this.sessionCheckEventListener=e=>{let s=e.origin.toLowerCase(),r=this.issuer.toLowerCase();if(this.debug("sessionCheckEventListener"),!r.startsWith(s)){this.debug("sessionCheckEventListener","wrong origin",s,"expected",r,"event",e);return}switch(e.data){case"unchanged":this.ngZone.run(()=>{this.handleSessionUnchanged()});break;case"changed":this.ngZone.run(()=>{this.handleSessionChange()});break;case"error":this.ngZone.run(()=>{this.handleSessionError()});break}this.debug("got info from session check inframe",e)},this.ngZone.runOutsideAngular(()=>{window.addEventListener("message",this.sessionCheckEventListener)})}handleSessionUnchanged(){this.debug("session check","session unchanged"),this.eventsSubject.next(new C("session_unchanged"))}handleSessionChange(){this.eventsSubject.next(new C("session_changed")),this.stopSessionCheckTimer(),!this.useSilentRefresh&&this.responseType==="code"?this.refreshToken().then(()=>{this.debug("token refresh after session change worked")}).catch(()=>{this.debug("token refresh did not work after session changed"),this.eventsSubject.next(new C("session_terminated")),this.logOut(!0)}):this.silentRefreshRedirectUri?(this.silentRefresh().catch(()=>this.debug("silent refresh failed after session changed")),this.waitForSilentRefreshAfterSessionChange()):(this.eventsSubject.next(new C("session_terminated")),this.logOut(!0))}waitForSilentRefreshAfterSessionChange(){this.events.pipe(T(e=>e.type==="silently_refreshed"||e.type==="silent_refresh_timeout"||e.type==="silent_refresh_error"),K()).subscribe(e=>{e.type!=="silently_refreshed"&&(this.debug("silent refresh did not work after session changed"),this.eventsSubject.next(new C("session_terminated")),this.logOut(!0))})}handleSessionError(){this.stopSessionCheckTimer(),this.eventsSubject.next(new C("session_error"))}removeSessionCheckEventListener(){this.sessionCheckEventListener&&(window.removeEventListener("message",this.sessionCheckEventListener),this.sessionCheckEventListener=null)}initSessionCheck(){if(!this.canPerformSessionCheck())return;let e=this.document.getElementById(this.sessionCheckIFrameName);e&&this.document.body.removeChild(e);let s=this.document.createElement("iframe");s.id=this.sessionCheckIFrameName,this.setupSessionCheckEventListener();let r=this.sessionCheckIFrameUrl;s.setAttribute("src",r),s.style.display="none",this.document.body.appendChild(s),this.startSessionCheckTimer()}startSessionCheckTimer(){this.stopSessionCheckTimer(),this.ngZone.runOutsideAngular(()=>{this.sessionCheckTimer=setInterval(this.checkSession.bind(this),this.sessionCheckIntervall)})}stopSessionCheckTimer(){this.sessionCheckTimer&&(clearInterval(this.sessionCheckTimer),this.sessionCheckTimer=null)}checkSession(){let e=this.document.getElementById(this.sessionCheckIFrameName);e||this.logger.warn("checkSession did not find iframe",this.sessionCheckIFrameName);let s=this.getSessionState();s||this.stopSessionCheckTimer();let r=this.clientId+" "+s;e.contentWindow.postMessage(r,this.issuer)}createLoginUrl(){return E(this,arguments,function*(e="",s="",r="",i=!1,n={}){let a=this,f;r?f=r:f=this.redirectUri;let d=yield this.createAndSaveNonce();if(e?e=d+this.config.nonceStateSeparator+encodeURIComponent(e):e=d,!this.requestAccessToken&&!this.oidc)throw new Error("Either requestAccessToken or oidc or both must be true");this.config.responseType?this.responseType=this.config.responseType:this.oidc&&this.requestAccessToken?this.responseType="id_token token":this.oidc&&!this.requestAccessToken?this.responseType="id_token":this.responseType="token";let p=a.loginUrl.indexOf("?")>-1?"&":"?",l=a.scope;this.oidc&&!l.match(/(^|\s)openid($|\s)/)&&(l="openid "+l);let h=a.loginUrl+p+"response_type="+encodeURIComponent(a.responseType)+"&client_id="+encodeURIComponent(a.clientId)+"&state="+encodeURIComponent(e)+"&redirect_uri="+encodeURIComponent(f)+"&scope="+encodeURIComponent(l);if(this.responseType.includes("code")&&!this.disablePKCE){let[u,v]=yield this.createChallangeVerifierPairForPKCE();this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?localStorage.setItem("PKCE_verifier",v):this._storage.setItem("PKCE_verifier",v),h+="&code_challenge="+u,h+="&code_challenge_method=S256"}s&&(h+="&login_hint="+encodeURIComponent(s)),a.resource&&(h+="&resource="+encodeURIComponent(a.resource)),a.oidc&&(h+="&nonce="+encodeURIComponent(d)),i&&(h+="&prompt=none");for(let u of Object.keys(n))h+="&"+encodeURIComponent(u)+"="+encodeURIComponent(n[u]);if(this.customQueryParams)for(let u of Object.getOwnPropertyNames(this.customQueryParams))h+="&"+u+"="+encodeURIComponent(this.customQueryParams[u]);return h})}initImplicitFlowInternal(e="",s=""){if(this.inImplicitFlow)return;if(this.inImplicitFlow=!0,!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");let r={},i=null;typeof s=="string"?i=s:typeof s=="object"&&(r=s),this.createLoginUrl(e,i,null,!1,r).then(this.config.openUri).catch(n=>{console.error("Error in initImplicitFlow",n),this.inImplicitFlow=!1})}initImplicitFlow(e="",s=""){this.loginUrl!==""?this.initImplicitFlowInternal(e,s):this.events.pipe(T(r=>r.type==="discovery_document_loaded")).subscribe(()=>this.initImplicitFlowInternal(e,s))}resetImplicitFlow(){this.inImplicitFlow=!1}callOnTokenReceivedIfExists(e){let s=this;if(e.onTokenReceived){let r={idClaims:s.getIdentityClaims(),idToken:s.getIdToken(),accessToken:s.getAccessToken(),state:s.state};e.onTokenReceived(r)}}storeAccessTokenResponse(e,s,r,i,n){if(this._storage.setItem("access_token",e),i&&!Array.isArray(i)?this._storage.setItem("granted_scopes",JSON.stringify(i.split(" "))):i&&Array.isArray(i)&&this._storage.setItem("granted_scopes",JSON.stringify(i)),this._storage.setItem("access_token_stored_at",""+this.dateTimeService.now()),r){let a=r*1e3,d=this.dateTimeService.new().getTime()+a;this._storage.setItem("expires_at",""+d)}s&&this._storage.setItem("refresh_token",s),n&&n.forEach((a,f)=>{this._storage.setItem(f,a)})}tryLogin(e=null){return this.config.responseType==="code"?this.tryLoginCodeFlow(e).then(()=>!0):this.tryLoginImplicitFlow(e)}parseQueryString(e){return!e||e.length===0?{}:(e.charAt(0)==="?"&&(e=e.substr(1)),this.urlHelper.parseQueryString(e))}tryLoginCodeFlow(e=null){return E(this,null,function*(){e=e||{};let s=e.customHashFragment?e.customHashFragment.substring(1):window.location.search,r=this.getCodePartsFromUrl(s),i=r.code,n=r.state,a=r.session_state;if(!e.preventClearHashAfterLogin){let p=location.origin+location.pathname+location.search.replace(/code=[^&$]*/,"").replace(/scope=[^&$]*/,"").replace(/state=[^&$]*/,"").replace(/session_state=[^&$]*/,"").replace(/^\?&/,"?").replace(/&$/,"").replace(/^\?$/,"").replace(/&+/g,"&").replace(/\?&/,"?").replace(/\?$/,"")+location.hash;history.replaceState(null,window.name,p)}let[f,d]=this.parseState(n);if(this.state=d,r.error){this.debug("error trying to login"),this.handleLoginError(e,r);let p=new k("code_error",{},r);return this.eventsSubject.next(p),Promise.reject(p)}if(!e.disableNonceCheck){if(!f)return this.saveRequestedRoute(),Promise.resolve();if(!e.disableOAuth2StateCheck&&!this.validateNonce(f)){let l=new k("invalid_nonce_in_state",null);return this.eventsSubject.next(l),Promise.reject(l)}}return this.storeSessionState(a),i&&(yield this.getTokenFromCode(i,e),this.restoreRequestedRoute()),Promise.resolve()})}saveRequestedRoute(){this.config.preserveRequestedRoute&&this._storage.setItem("requested_route",window.location.pathname+window.location.search)}restoreRequestedRoute(){let e=this._storage.getItem("requested_route");e&&history.replaceState(null,"",window.location.origin+e)}getCodePartsFromUrl(e){return!e||e.length===0?this.urlHelper.getHashFragmentParams():(e.charAt(0)==="?"&&(e=e.substr(1)),this.urlHelper.parseQueryString(e))}getTokenFromCode(e,s){let r=new N({encoder:new F}).set("grant_type","authorization_code").set("code",e).set("redirect_uri",s.customRedirectUri||this.redirectUri);if(!this.disablePKCE){let i;this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?i=localStorage.getItem("PKCE_verifier"):i=this._storage.getItem("PKCE_verifier"),i?r=r.set("code_verifier",i):console.warn("No PKCE verifier found in oauth storage!")}return this.fetchAndProcessToken(r,s)}fetchAndProcessToken(e,s){s=s||{},this.assertUrlNotNullAndCorrectProtocol(this.tokenEndpoint,"tokenEndpoint");let r=new U().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let i=btoa(`${this.clientId}:${this.dummyClientSecret}`);r=r.set("Authorization","Basic "+i)}return this.useHttpBasicAuth||(e=e.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(e=e.set("client_secret",this.dummyClientSecret)),new Promise((i,n)=>{if(this.customQueryParams)for(let a of Object.getOwnPropertyNames(this.customQueryParams))e=e.set(a,this.customQueryParams[a]);this.http.post(this.tokenEndpoint,e,{headers:r}).subscribe(a=>{this.debug("refresh tokenResponse",a),this.storeAccessTokenResponse(a.access_token,a.refresh_token,a.expires_in||this.fallbackAccessTokenExpirationTimeInSec,a.scope,this.extractRecognizedCustomParameters(a)),this.oidc&&a.id_token?this.processIdToken(a.id_token,a.access_token,s.disableNonceCheck).then(f=>{this.storeIdToken(f),this.eventsSubject.next(new b("token_received")),this.eventsSubject.next(new b("token_refreshed")),i(a)}).catch(f=>{this.eventsSubject.next(new k("token_validation_error",f)),console.error("Error validating tokens"),console.error(f),n(f)}):(this.eventsSubject.next(new b("token_received")),this.eventsSubject.next(new b("token_refreshed")),i(a))},a=>{console.error("Error getting token",a),this.eventsSubject.next(new k("token_refresh_error",a)),n(a)})})}tryLoginImplicitFlow(e=null){e=e||{};let s;e.customHashFragment?s=this.urlHelper.getHashFragmentParams(e.customHashFragment):s=this.urlHelper.getHashFragmentParams(),this.debug("parsed url",s);let r=s.state,[i,n]=this.parseState(r);if(this.state=n,s.error){this.debug("error trying to login"),this.handleLoginError(e,s);let l=new k("token_error",{},s);return this.eventsSubject.next(l),Promise.reject(l)}let a=s.access_token,f=s.id_token,d=s.session_state,p=s.scope;if(!this.requestAccessToken&&!this.oidc)return Promise.reject("Either requestAccessToken or oidc (or both) must be true.");if(this.requestAccessToken&&!a||this.requestAccessToken&&!e.disableOAuth2StateCheck&&!r||this.oidc&&!f)return Promise.resolve(!1);if(this.sessionChecksEnabled&&!d&&this.logger.warn("session checks (Session Status Change Notification) were activated in the configuration but the id_token does not contain a session_state claim"),this.requestAccessToken&&!e.disableNonceCheck&&!this.validateNonce(i)){let h=new k("invalid_nonce_in_state",null);return this.eventsSubject.next(h),Promise.reject(h)}return this.requestAccessToken&&this.storeAccessTokenResponse(a,null,s.expires_in||this.fallbackAccessTokenExpirationTimeInSec,p),this.oidc?this.processIdToken(f,a,e.disableNonceCheck).then(l=>e.validationHandler?e.validationHandler({accessToken:a,idClaims:l.idTokenClaims,idToken:l.idToken,state:r}).then(()=>l):l).then(l=>(this.storeIdToken(l),this.storeSessionState(d),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash(),this.eventsSubject.next(new b("token_received")),this.callOnTokenReceivedIfExists(e),this.inImplicitFlow=!1,!0)).catch(l=>(this.eventsSubject.next(new k("token_validation_error",l)),this.logger.error("Error validating tokens"),this.logger.error(l),Promise.reject(l))):(this.eventsSubject.next(new b("token_received")),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash(),this.callOnTokenReceivedIfExists(e),Promise.resolve(!0))}parseState(e){let s=e,r="";if(e){let i=e.indexOf(this.config.nonceStateSeparator);i>-1&&(s=e.substr(0,i),r=e.substr(i+this.config.nonceStateSeparator.length))}return[s,r]}validateNonce(e){let s;return this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?s=localStorage.getItem("nonce"):s=this._storage.getItem("nonce"),s!==e?(console.error("Validating access_token failed, wrong state/nonce.",s,e),!1):!0}storeIdToken(e){this._storage.setItem("id_token",e.idToken),this._storage.setItem("id_token_claims_obj",e.idTokenClaimsJson),this._storage.setItem("id_token_expires_at",""+e.idTokenExpiresAt),this._storage.setItem("id_token_stored_at",""+this.dateTimeService.now())}storeSessionState(e){this._storage.setItem("session_state",e)}getSessionState(){return this._storage.getItem("session_state")}handleLoginError(e,s){e.onLoginError&&e.onLoginError(s),this.clearHashAfterLogin&&!e.preventClearHashAfterLogin&&this.clearLocationHash()}getClockSkewInMsec(e=6e5){return!this.clockSkewInSec&&this.clockSkewInSec!==0?e:this.clockSkewInSec*1e3}processIdToken(e,s,r=!1){let i=e.split("."),n=this.padBase64(i[0]),a=ut(n),f=JSON.parse(a),d=this.padBase64(i[1]),p=ut(d),l=JSON.parse(p),h;if(this.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?h=localStorage.getItem("nonce"):h=this._storage.getItem("nonce"),Array.isArray(l.aud)){if(l.aud.every(m=>m!==this.clientId)){let m="Wrong audience: "+l.aud.join(",");return this.logger.warn(m),Promise.reject(m)}}else if(l.aud!==this.clientId){let m="Wrong audience: "+l.aud;return this.logger.warn(m),Promise.reject(m)}if(!l.sub){let m="No sub claim in id_token";return this.logger.warn(m),Promise.reject(m)}if(this.sessionChecksEnabled&&this.silentRefreshSubject&&this.silentRefreshSubject!==l.sub){let m=`After refreshing, we got an id_token for another user (sub). Expected sub: ${this.silentRefreshSubject}, received sub: ${l.sub}`;return this.logger.warn(m),Promise.reject(m)}if(!l.iat){let m="No iat claim in id_token";return this.logger.warn(m),Promise.reject(m)}if(!this.skipIssuerCheck&&l.iss!==this.issuer){let m="Wrong issuer: "+l.iss;return this.logger.warn(m),Promise.reject(m)}if(!r&&l.nonce!==h){let m="Wrong nonce: "+l.nonce;return this.logger.warn(m),Promise.reject(m)}if(Object.prototype.hasOwnProperty.call(this,"responseType")&&(this.responseType==="code"||this.responseType==="id_token")&&(this.disableAtHashCheck=!0),!this.disableAtHashCheck&&this.requestAccessToken&&!l.at_hash){let m="An at_hash is needed!";return this.logger.warn(m),Promise.reject(m)}let u=this.dateTimeService.now(),v=l.iat*1e3,S=l.exp*1e3,H=this.getClockSkewInMsec();if(v-H>=u||S+H-this.decreaseExpirationBySec<=u){let m="Token has expired";return console.error(m),console.error({now:u,issuedAtMSec:v,expiresAtMSec:S}),Promise.reject(m)}let J={accessToken:s,idToken:e,jwks:this.jwks,idTokenClaims:l,idTokenHeader:f,loadKeys:()=>this.loadJwks()};return this.disableAtHashCheck?this.checkSignature(J).then(()=>({idToken:e,idTokenClaims:l,idTokenClaimsJson:p,idTokenHeader:f,idTokenHeaderJson:a,idTokenExpiresAt:S})):this.checkAtHash(J).then(m=>{if(!this.disableAtHashCheck&&this.requestAccessToken&&!m){let $="Wrong at_hash";return this.logger.warn($),Promise.reject($)}return this.checkSignature(J).then(()=>{let $=!this.disableAtHashCheck,Ue={idToken:e,idTokenClaims:l,idTokenClaimsJson:p,idTokenHeader:f,idTokenHeaderJson:a,idTokenExpiresAt:S};return $?this.checkAtHash(J).then(It=>{if(this.requestAccessToken&&!It){let Le="Wrong at_hash";return this.logger.warn(Le),Promise.reject(Le)}else return Ue}):Ue})})}getIdentityClaims(){let e=this._storage.getItem("id_token_claims_obj");return e?JSON.parse(e):null}getGrantedScopes(){let e=this._storage.getItem("granted_scopes");return e?JSON.parse(e):null}getIdToken(){return this._storage?this._storage.getItem("id_token"):null}padBase64(e){for(;e.length%4!==0;)e+="=";return e}getAccessToken(){return this._storage?this._storage.getItem("access_token"):null}getRefreshToken(){return this._storage?this._storage.getItem("refresh_token"):null}getAccessTokenExpiration(){return this._storage.getItem("expires_at")?parseInt(this._storage.getItem("expires_at"),10):null}getAccessTokenStoredAt(){return parseInt(this._storage.getItem("access_token_stored_at"),10)}getIdTokenStoredAt(){return parseInt(this._storage.getItem("id_token_stored_at"),10)}getIdTokenExpiration(){return this._storage.getItem("id_token_expires_at")?parseInt(this._storage.getItem("id_token_expires_at"),10):null}hasValidAccessToken(){if(this.getAccessToken()){let e=this._storage.getItem("expires_at"),s=this.dateTimeService.new();return!(e&&parseInt(e,10)-this.decreaseExpirationBySec<s.getTime()-this.getClockSkewInMsec())}return!1}hasValidIdToken(){if(this.getIdToken()){let e=this._storage.getItem("id_token_expires_at"),s=this.dateTimeService.new();return!(e&&parseInt(e,10)-this.decreaseExpirationBySec<s.getTime()-this.getClockSkewInMsec())}return!1}getCustomTokenResponseProperty(e){return this._storage&&this.config.customTokenParameters&&this.config.customTokenParameters.indexOf(e)>=0&&this._storage.getItem(e)!==null?JSON.parse(this._storage.getItem(e)):null}authorizationHeader(){return"Bearer "+this.getAccessToken()}logOut(e={},s=""){let r=!1;typeof e=="boolean"&&(r=e,e={});let i=this.getIdToken();if(this._storage.removeItem("access_token"),this._storage.removeItem("id_token"),this._storage.removeItem("refresh_token"),this.saveNoncesInLocalStorage?(localStorage.removeItem("nonce"),localStorage.removeItem("PKCE_verifier")):(this._storage.removeItem("nonce"),this._storage.removeItem("PKCE_verifier")),this._storage.removeItem("expires_at"),this._storage.removeItem("id_token_claims_obj"),this._storage.removeItem("id_token_expires_at"),this._storage.removeItem("id_token_stored_at"),this._storage.removeItem("access_token_stored_at"),this._storage.removeItem("granted_scopes"),this._storage.removeItem("session_state"),this.config.customTokenParameters&&this.config.customTokenParameters.forEach(a=>this._storage.removeItem(a)),this.silentRefreshSubject=null,this.eventsSubject.next(new C("logout")),!this.logoutUrl||r)return;let n;if(!this.validateUrlForHttps(this.logoutUrl))throw new Error("logoutUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");if(this.logoutUrl.indexOf("{{")>-1)n=this.logoutUrl.replace(/\{\{id_token\}\}/,encodeURIComponent(i)).replace(/\{\{client_id\}\}/,encodeURIComponent(this.clientId));else{let a=new N({encoder:new F});i&&(a=a.set("id_token_hint",i));let f=this.postLogoutRedirectUri||this.redirectUriAsPostLogoutRedirectUriFallback&&this.redirectUri||"";f&&(a=a.set("post_logout_redirect_uri",f),s&&(a=a.set("state",s)));for(let d in e)a=a.set(d,e[d]);n=this.logoutUrl+(this.logoutUrl.indexOf("?")>-1?"&":"?")+a.toString()}this.config.openUri(n)}createAndSaveNonce(){let e=this;return this.createNonce().then(function(s){return e.saveNoncesInLocalStorage&&typeof window.localStorage<"u"?localStorage.setItem("nonce",s):e._storage.setItem("nonce",s),s})}ngOnDestroy(){this.clearAccessTokenTimer(),this.clearIdTokenTimer(),this.removeSilentRefreshEventListener();let e=this.document.getElementById(this.silentRefreshIFrameName);e&&e.remove(),this.stopSessionCheckTimer(),this.removeSessionCheckEventListener();let s=this.document.getElementById(this.sessionCheckIFrameName);s&&s.remove()}createNonce(){return new Promise(e=>{if(this.rngUrl)throw new Error("createNonce with rng-web-api has not been implemented so far");let s="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",r=45,i="",n=typeof self>"u"?null:self.crypto||self.msCrypto;if(n){let a=new Uint8Array(r);n.getRandomValues(a),a.map||(a.map=Array.prototype.map),a=a.map(f=>s.charCodeAt(f%s.length)),i=String.fromCharCode.apply(null,a)}else for(;0<r--;)i+=s[Math.random()*s.length|0];e(ht(i))})}checkAtHash(e){return E(this,null,function*(){return this.tokenValidationHandler?this.tokenValidationHandler.validateAtHash(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check at_hash."),!0)})}checkSignature(e){return this.tokenValidationHandler?this.tokenValidationHandler.validateSignature(e):(this.logger.warn("No tokenValidationHandler configured. Cannot check signature."),Promise.resolve(null))}initLoginFlow(e="",s={}){return this.responseType==="code"?this.initCodeFlow(e,s):this.initImplicitFlow(e,s)}initCodeFlow(e="",s={}){this.loginUrl!==""?this.initCodeFlowInternal(e,s):this.events.pipe(T(r=>r.type==="discovery_document_loaded")).subscribe(()=>this.initCodeFlowInternal(e,s))}initCodeFlowInternal(e="",s={}){if(!this.validateUrlForHttps(this.loginUrl))throw new Error("loginUrl  must use HTTPS (with TLS), or config value for property 'requireHttps' must be set to 'false' and allow HTTP (without TLS).");let r={},i=null;typeof s=="string"?i=s:typeof s=="object"&&(r=s),this.createLoginUrl(e,i,null,!1,r).then(this.config.openUri).catch(n=>{console.error("Error in initAuthorizationCodeFlow"),console.error(n)})}createChallangeVerifierPairForPKCE(){return E(this,null,function*(){if(!this.crypto)throw new Error("PKCE support for code flow needs a CryptoHander. Did you import the OAuthModule using forRoot() ?");let e=yield this.createNonce(),s=yield this.crypto.calcHash(e,"sha-256");return[ht(s),e]})}extractRecognizedCustomParameters(e){let s=new Map;return this.config.customTokenParameters&&this.config.customTokenParameters.forEach(r=>{e[r]&&s.set(r,JSON.stringify(e[r]))}),s}revokeTokenAndLogout(e={},s=!1){let r=this.revocationEndpoint,i=this.getAccessToken(),n=this.getRefreshToken();if(!i)return Promise.resolve();let a=new N({encoder:new F}),f=new U().set("Content-Type","application/x-www-form-urlencoded");if(this.useHttpBasicAuth){let d=btoa(`${this.clientId}:${this.dummyClientSecret}`);f=f.set("Authorization","Basic "+d)}if(this.useHttpBasicAuth||(a=a.set("client_id",this.clientId)),!this.useHttpBasicAuth&&this.dummyClientSecret&&(a=a.set("client_secret",this.dummyClientSecret)),this.customQueryParams)for(let d of Object.getOwnPropertyNames(this.customQueryParams))a=a.set(d,this.customQueryParams[d]);return new Promise((d,p)=>{let l,h;if(i){let u=a.set("token",i).set("token_type_hint","access_token");l=this.http.post(r,u,{headers:f})}else l=w(null);if(n){let u=a.set("token",n).set("token_type_hint","refresh_token");h=this.http.post(r,u,{headers:f})}else h=w(null);s&&(l=l.pipe(O(u=>u.status===0?w(null):M(u))),h=h.pipe(O(u=>u.status===0?w(null):M(u)))),Fe([l,h]).subscribe(u=>{this.logOut(e),d(u),this.logger.info("Token successfully revoked")},u=>{this.logger.error("Error revoking token",u),this.eventsSubject.next(new k("token_revoke_error",u)),p(u)})})}clearLocationHash(){location.hash!=""&&(location.hash="")}};t.\u0275fac=function(s){return new(s||t)(x($e),x(Ze),x(se,8),x(re,8),x(B,8),x(dt),x(te),x(oe,8),x(qe),x(Y))},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})(),ie=class{},Ie=class{handleError(t){return M(t)}},Ht=(()=>{let t=class t{constructor(e,s,r){this.oAuthService=e,this.errorHandler=s,this.moduleConfig=r}checkUrl(e){return this.moduleConfig.resourceServer.customUrlValidation?this.moduleConfig.resourceServer.customUrlValidation(e):this.moduleConfig.resourceServer.allowedUrls?!!this.moduleConfig.resourceServer.allowedUrls.find(s=>e.toLowerCase().startsWith(s.toLowerCase())):!0}intercept(e,s){let r=e.url.toLowerCase();return!this.moduleConfig||!this.moduleConfig.resourceServer||!this.checkUrl(r)?s.handle(e):this.moduleConfig.resourceServer.sendAccessToken?Re(w(this.oAuthService.getAccessToken()).pipe(T(n=>!!n)),this.oAuthService.events.pipe(T(n=>n.type==="token_received"),He(this.oAuthService.waitForTokenInMsec||0),O(()=>w(null)),Q(()=>this.oAuthService.getAccessToken()))).pipe(Be(1),Me(n=>{if(n){let a="Bearer "+n,f=e.headers.set("Authorization",a);e=e.clone({headers:f})}return s.handle(e).pipe(O(a=>this.errorHandler.handleError(a)))})):s.handle(e).pipe(O(n=>this.errorHandler.handleError(n)))}};t.\u0275fac=function(s){return new(s||t)(x(pt),x(ie),x(ee,8))},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})();function Ft(){return console}function Mt(){return typeof sessionStorage<"u"?sessionStorage:new Et}function Rt(o=null,t=X){return Je([pt,dt,{provide:te,useFactory:Ft},{provide:se,useFactory:Mt},{provide:re,useClass:t},{provide:oe,useClass:Pt},{provide:ie,useClass:Ie},{provide:ee,useValue:o},{provide:I,useClass:Ht,multi:!0},{provide:Y,useClass:At}])}var gt=(()=>{let t=class t{static forRoot(e=null,s=X){return{ngModule:t,providers:[Rt(e,s)]}}};t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=D({type:t}),t.\u0275inj=j({imports:[Ke]});let o=t;return o})();var ls=new Ye("AUTH_CONFIG");function V(o){"@babel/helpers - typeof";return V=typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?function(t){return typeof t}:function(t){return t&&typeof Symbol=="function"&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},V(o)}function A(o){if(o===null||o===!0||o===!1)return NaN;var t=Number(o);return isNaN(t)?t:t<0?Math.ceil(t):Math.floor(t)}function g(o,t){if(t.length<o)throw new TypeError(o+" argument"+(o>1?"s":"")+" required, but only "+t.length+" present")}function y(o){g(1,arguments);var t=Object.prototype.toString.call(o);return o instanceof Date||V(o)==="object"&&t==="[object Date]"?new Date(o.getTime()):typeof o=="number"||t==="[object Number]"?new Date(o):((typeof o=="string"||t==="[object String]")&&typeof console<"u"&&(console.warn("Starting with v2.0.0-beta.1 date-fns doesn't accept strings as date arguments. Please use `parseISO` to parse strings. See: https://github.com/date-fns/date-fns/blob/master/docs/upgradeGuide.md#string-arguments"),console.warn(new Error().stack)),new Date(NaN))}function Ce(o,t){g(2,arguments);var c=y(o),e=A(t);return isNaN(e)?new Date(NaN):(e&&c.setDate(c.getDate()+e),c)}function Ae(o,t){g(2,arguments);var c=y(o),e=A(t);if(isNaN(e))return new Date(NaN);if(!e)return c;var s=c.getDate(),r=new Date(c.getTime());r.setMonth(c.getMonth()+e+1,0);var i=r.getDate();return s>=i?r:(c.setFullYear(r.getFullYear(),r.getMonth(),s),c)}function Ee(o){g(1,arguments);var t=y(o);return t.setHours(0,0,0,0),t}function Oe(o,t){g(2,arguments);var c=A(t),e=c*7;return Ce(o,e)}function je(o){g(1,arguments);var t=y(o);return t.setHours(23,59,59,999),t}function ne(o){g(1,arguments);var t=y(o),c=t.getMonth();return t.setFullYear(t.getFullYear(),c+1,0),t.setHours(23,59,59,999),t}function ae(o){g(1,arguments);var t=y(o);return t.setDate(1),t.setHours(0,0,0,0),t}function ce(o){g(1,arguments);var t=y(o),c=t.getFullYear();return t.setFullYear(c+1,0,0),t.setHours(23,59,59,999),t}function le(o){g(1,arguments);var t=y(o),c=new Date(0);return c.setFullYear(t.getFullYear(),0,1),c.setHours(0,0,0,0),c}function fe(){return je(Date.now())}function ue(){return Ee(Date.now())}function he(o,t){g(2,arguments);var c=A(t);return Ae(o,-c)}function de(o,t){g(2,arguments);var c=A(t);return Oe(o,-c)}var vr=de(ue(),2),wr=fe(),yr=ae(he(new Date,2)),Sr=ne(new Date),_r=le(new Date),br=ce(new Date);var xt=o=>Object.values(o).filter(t=>Number.isInteger(t)).map(t=>({text:`${o[Number(t)]}`,value:t}));var De=function(o){return o.vi="vi-VN",o.en="en-US",o}(De||{}),kt=De.vi,Ar=xt(De).map(({text:o})=>o);var vt=()=>localStorage.getItem("lang")||kt;var wt=()=>{let o=localStorage.getItem("id_token_claims_obj");if(o){let t=JSON.parse(o);if(t)return t.tenantid}};var me=class{intercept(t,c){if(!t.headers.has("Accept-Language")){let e=vt(),s=t.headers.set("Accept-Language",e),r=t.clone({headers:s});return c.handle(r)}return c.handle(t)}};var yt=(()=>{let t=class t{intercept(e,s){if(!e.url.includes("http")){let r=e.clone({url:`${it.config.apiUrl}/${e.url}`});return s.handle(r)}return s.handle(e)}};t.\u0275fac=function(s){return new(s||t)},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})();var pe=class{intercept(t,c){if(t.url.includes("api/")&&!t.headers.has("Authorization")){let e=localStorage.getItem("access_token");if(e){let s=t.headers.set("Authorization",`Bearer ${e}`),r=t.clone({headers:s});return c.handle(r)}}return c.handle(t)}};var ge=class{intercept(t,c){if(t.url.includes("api/")){let e=wt();if(e){let s=t.headers.set("tenantid",`${e}`),r=t.clone({headers:s});return c.handle(r)}}return c.handle(t)}};var xe=class{intercept(t,c){if(!t.headers.has("X-TimezoneOffset")){let e=t.headers.set("X-TimezoneOffset",`${new Date().getTimezoneOffset()}`),s=t.clone({headers:e});return c.handle(s)}return c.handle(t)}};var ke=class{intercept(t,c){if(!t.headers.has("is_workspace")){let e=localStorage.getItem("is_workspace");if(e){let s=e=="Workspace",r=t.headers.set("is_workspace",`${s}`),i=t.clone({headers:r});return c.handle(i)}}return c.handle(t)}};var St=[{provide:I,useClass:pe,multi:!0},{provide:I,useClass:yt,multi:!0},{provide:I,useClass:me,multi:!0},{provide:I,useClass:xe,multi:!0},{provide:I,useClass:ge,multi:!0},{provide:I,useClass:ke,multi:!0}];var _t=(()=>{let t=class t{constructor(e,s){this._authService=e,this._router=s}intercept(e,s){let r=e.clone();return this._authService.accessToken&&!nt.isTokenExpired(this._authService.accessToken)&&(r=e.clone({headers:e.headers.set("Authorization","Bearer "+this._authService.accessToken)})),s.handle(r).pipe(O(i=>(i instanceof Ge&&(i.status===403||i.status===401)&&this._authService.authenticated&&this._router.navigate(["sign-out"]),M(i))))}};t.\u0275fac=function(s){return new(s||t)(x(L),x(W))},t.\u0275prov=_({token:t,factory:t.\u0275fac});let o=t;return o})();var bt=(()=>{let t=class t{};t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=D({type:t}),t.\u0275inj=j({providers:[L,{provide:I,useClass:_t,multi:!0}],imports:[G]});let o=t;return o})();var Nt={message:{nzMaxStack:3,nzDuration:5e3},pagination:{nzPageSizeOptions:[10,20,30,40,100,200]},badge:{nzOverflowCount:9},tabs:{nzTabBarGutter:-10},theme:{primaryColor:"#1f4a7c"},form:{nzTooltipIcon:"info-circle"}},Tt=(()=>{let t=class t{};t.\u0275fac=function(s){return new(s||t)},t.\u0275mod=D({type:t,bootstrap:[ct]}),t.\u0275inj=j({providers:[{provide:st,useValue:Nt},...St],imports:[et,ft,G,tt,bt,gt.forRoot()]});let o=t;return o})();Xe().bootstrapModule(Tt).catch(o=>console.error(o));
